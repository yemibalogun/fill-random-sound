<!DOCTYPE html>
<!-- This document forms the dockable panel. The button is the <input> tag below. The <style> formats the button. 

		The extendscript is called through the <script type="text/javascript"> tag, which then routes it to use the adobe_cep_.evalScript to interpret that Javascript into Extendscript -->

<html>
	<head>
		<meta charset="utf-8">
		<title>Alert Panel</title>
		<script src="./ext.js"></script>
		<script src="./lib/CSInterface.js"></script>
		<script src="./lib/jquery-1.9.1.js"></script>
		<script src="./lib/Vulcan.js"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
		<link id="ppstyle" href="css/style.css" rel="stylesheet" type="text/css">		
		<script type="text/javascript">
			
			function runAll() {
				var cs = new CSInterface;
				cs.evalScript('$.runScript.alert()')
			}

			function onLoaded() {
            var cs = new CSInterface();
            cs.evalScript('$.runScript.initialize()', function(result) {
                document.getElementById('username').textContent = result;
            });

            // Set version and sequence info
            cs.evalScript('$.runScript.getVersion()', function(result) {
                document.getElementById('version_string').textContent = result;
            });

            cs.evalScript('$.runScript.getActiveSequence()', function(result) {
                document.getElementById('active_seq').textContent = result;
            });

            cs.evalScript('$.runScript.getProxiesStatus()', function(result) {
                document.getElementById('proxies_on').textContent += result;
            });

			// Populate bins dropdown
			populateBinsDropdown();
        }

        function evalScript(script) {
            var cs = new CSInterface();
            cs.evalScript(script);
        }	

		// Call the ExtendScript to get all bins
        function populateBinsDropdown() {
		var cs = new CSInterface();
		cs.evalScript('$.runScript.getBins()', function(bins) {
			console.log("Bins retrieved: ", bins); // Log the retrieved bins
			try {
				var binsList = JSON.parse(bins); // Expecting a JSON string from ExtendScript
				var select = document.getElementById('binSelect');
				select.innerHTML = ''; // Clear existing options

				// Add each bin to the dropdown
				binsList.forEach(function(bin) {
					var option = document.createElement('option');
					option.value = bin.id; // Use bin ID
					option.text = bin.name;
					select.appendChild(option);
				});
			} catch (error) {
				console.error("Error parsing bins: ", error); // Log parsing errors
			}
		});
	}


		function insertAudio() {
			// Get the track number from the input field
			var trackNumber = document.getElementById('trackNumberInput').value;
			var selectedBinId = document.getElementById('binSelect').value;
            
			// Call the insertAudioFromBinToMarkedPoints function with the track number
			var script = `$.runScript.insertAudioFromBinToMarkedPoints(${trackNumber}, "${selectedBinId}")`;
			evalScript(script);
		}
		</script>
		
	</head>

	<body onLoad="onLoaded()">
		<div class="div">
			<a href="javascript:history.go(0)"><span class="material-symbols-outlined">
				refresh
				</span></a>
		</div>
		
		<div id="section2" class="sectionID">
			<div class="row">
				<!-- Input field for track number -->
				<label for="trackNumberInput">Track Number:</label>
				<input type="number" id="trackNumberInput" min="1" placeholder="Enter track number" />
			</div>

			<div class="row">
				<!-- Dropdown for selecting bins -->
				<label for="binSelect">Select Bin:</label>
				<select id="binSelect"></select>
			</div>

			<!-- Button to insert audio into the specified track -->
			<button class="controlBg textStyle" id="btn_PPRO101" onClick="insertAudio()">Insert Audio</button>
		</div>   
	</body>

	<script>
		document.body.onbeforeunload = function () {
			var csInterface 	= new CSInterface();
			var OSVersion 		= csInterface.getOSInformation();
			var appVersion 		= csInterface.hostEnvironment.appVersion;
			var versionAsFloat	= parseFloat(appVersion);
			
			csInterface.evalScript('$.runScript.closeLog()');
	
			if (versionAsFloat < 10.3) {
				var path = "file:///Library/Application Support/Adobe/CEP/extensions/PProPanel/payloads/onbeforeunload.html";
	
				if (OSVersion.indexOf("Windows") >= 0) {
					path = "file:///C:/Program%20Files%20(x86)/Common%20Files/Adobe/CEP/extensions/PProPanel/payloads/onbeforeunload.html"
				}
				csInterface.openURLInDefaultBrowser(path);
			}
		};
	</script>
</html>